#!/bin/bash

main() {
	[[ $# == 0 ]] && usage

	command="$1"

	case "$command" in
		get)
			"$command"
			;;
		set)
			"$command" "${@:2}"
			;;
		*)
			error "unknown argument: $command"
			;;
	esac
}

usage() {
	script_command="$(readlink -f "$0")"
	script_name="$(basename "$script_command")"

	echo "Usage: $script_name <command>"
	echo "Available commands: get, set [path]"
	exit 0
}

error() {
	echo "$1"
	exit 1
}

get() {

	if [[ "$GDMSESSION" == "gnome" ]]; then
		file=$(gsettings get org.gnome.desktop.background picture-uri)
	else
		file=$(awk '{print $4}' .fehbg)
	fi

	echo "${file/'file://'/''}"
}

set() {
	WALLPAPERS="${XDG_PICTURES_DIR:-$HOME/Pictures}/wallpapers"

	# resolve wallpaper from arguments or choose one randomly
	[[ $# > 0 ]] && wallpaper=$(realpath $1)
	[[ ! -f "$wallpaper" ]] && wallpaper=$(find $WALLPAPERS -type f -not -path "*/.git/*" | shuf -n 1)

	# set wallpaper
	if [[ "$GDMSESSION" == "gnome" ]]; then
		gsettings set org.gnome.desktop.background picture-uri "file://$wallpaper"
		gsettings set org.gnome.desktop.background picture-options "stretched"
	else
		feh --bg-fill "$wallpaper"
	fi

	# pywal: apply colorscheme
	~/.local/bin/wal -i "$wallpaper" -n
}

main "$@"
